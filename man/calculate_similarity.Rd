% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/similarity.R
\name{calculate_similarity}
\alias{calculate_similarity}
\title{Calculate Pairwise Similarity Matrix for Experimental Units}
\usage{
calculate_similarity(
  cov_data,
  covariate_types,
  weights,
  bandwidths,
  mixed_intervention = NA,
  mixed_dose = NA,
  mixed_allocation = NA
)
}
\arguments{
\item{cov_data}{A data frame where each row corresponds to an experimental unit (e.g., a study arm or cohort),
and each column corresponds to a covariate. In the example, this includes variables such as binary indicators,
composite labels, intervention type, dose, categorical and continuous patient characteristics.}

\item{covariate_types}{A character vector indicating the type of each covariate in \code{cov_data}.
Must match the column order of \code{cov_data}. Acceptable types are:
\itemize{
  \item \code{"binary"}: Exact match required (e.g., sex, condition presence).
  \item \code{"composite"}: Jaccard-like similarity (e.g., age group labels with multiple categories).
  \item \code{"categorical"}: One-hot encoded categorical distance (e.g., study phase).
  \item \code{"continuous"}: Gaussian kernel similarity based on numeric distance.
  \item \code{"ordinal"}: Linear scaled distance between levels (used internally for dose).
  \item \code{"Intervention"}: Special handling for treatment vs. placebo, including mixed arms.
  \item \code{"Dose"}: Paired with \code{"Intervention"} to assess similarity of treatment intensity.
}}

\item{weights}{A numeric vector of weights (one per covariate) that determines the contribution of each
covariate to the overall similarity score. Larger values assign more importance to that covariate.
Note: A weight should be specified for \code{"Intervention"} covariates, as these govern the core treatment
comparisons. The \code{"Dose"} covariate is used internally when \code{"Intervention"} is non-placebo,
but does not require a separate weight entry; it will be skipped during direct similarity computation.
In the example, \code{"Intervention"} receives a high weight (e.g., 10) to emphasize its influence,
while \code{"Dose"} has \code{NA} to indicate it's excluded from the weighted sum.}

\item{bandwidths}{A numeric vector of bandwidth parameters used only for continuous covariates.
Typically estimated as the pooled standard deviation across units (as shown in the example).
Set \code{NA} for non-continuous covariates.}

\item{mixed_intervention}{A character vector specifying the components of a "Mixed" intervention arm
under blinding (e.g., \code{c("A", "Placebo")}). Only required if \code{cov_data} includes "Mixed" in
the \code{"Intervention"} column.}

\item{mixed_dose}{A numeric vector giving the assumed dose levels corresponding to \code{mixed_intervention}.
For "Placebo", use \code{NA}. Used when computing similarity under blinding.}

\item{mixed_allocation}{A numeric vector (summing to 1) representing the assumed allocation proportions
to each treatment in the \code{mixed_intervention}. This reflects prior knowledge of randomization.
Used to compute expected similarity for a "Mixed" arm relative to other arms.}
}
\value{
A symmetric numeric matrix with dimensions equal to the number of rows in
  \code{cov_data}. Each entry (i, j) reflects the normalized similarity between
  experimental units i and j.
}
\description{
This function computes a pairwise similarity matrix among experimental units
based on covariate profiles. The similarities are used in the PPMx model to define
a covariate-dependent partition prior for clustering units with similar profiles.
The function accommodates multiple covariate types, including binary, continuous,
ordinal, categorical, and composite covariates, as well as special handling for
intervention and dose combinations, including mixed interventions under blinding.
}
\details{
The similarity function supports multiple covariate types and accounts for missing values
by computing similarity only over observed covariates for each unit pair. For intervention
covariates, the function handles mixed arms under blinding by computing a weighted
similarity based on assumed allocations to known treatments and corresponding doses.
For non-placebo matched interventions, similarity includes both binary agreement
and ordinal proximity of doses.

This function is central to computing the pairwise similarities \( s(x_u, x_{u'}) \)
that are averaged within clusters to define the PPMx similarity function used for
posterior inference and decision rules in AE monitoring.
}
\examples{
# Load unblinded data
indat <- read.csv("./data_unblind.csv")

# Separate outcome and covariate data
indat_outcome <- indat[, c("N", "T", "SAE")]
indat_cov <- indat[, setdiff(names(indat), c("N", "T", "SAE"))]

# Convert dose column to numeric values
indat_cov$Dose <- as.numeric(gsub("[^0-9]", "", indat_cov$Dose))

# Define covariate types and weights
covariate_types <- c("binary", "composite", "binary", "Intervention", "Dose", "categorical", "continuous")
weights <- c(2, 2, 5, 10, NA, 2, 2)

# Initialize bandwidths
bandwidths <- rep(NA, length(weights))
continuous_index <- which(covariate_types == "continuous")

# Extract mean and standard deviation for continuous variables
for (i in continuous_index) {
  means <- as.numeric(sub("(.*)\\\\(.*", "\\\\1", indat_cov[, i]))
  sds <- as.numeric(sub(".*\\\\((.*)\\\\).*", "\\\\1", indat_cov[, i]))
  indat_cov[, i] <- means
  bandwidths[i] <- sqrt(sum(indat_outcome$N * sds^2) / sum(indat_outcome$N))
}

# Compute similarity matrix for unblinded data
unblind_similarity_matrix <- calculate_similarity(
  cov_data = indat_cov,
  covariate_types = covariate_types,
  weights = weights,
  bandwidths = bandwidths
)

}
